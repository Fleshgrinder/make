#!/usr/bin/env bash
set -Eeuo pipefail

reset='\033[0m'
magenta='\033[0;35m'
red='\033[0;31m'

function error() {
    status=$1
    shift
    echo -e "\n${red}[ERROR]${reset} $*\n" >&2
    exit "$status"
}

missing=
for cmd in curl git jq make tar; do
    if ! command -v "$cmd" &>/dev/null; then
        [[ "$missing" == '' ]] || missing+=', '
        missing+="$magenta$cmd$reset"
    fi
done
if [[ "$missing" != '' ]]; then
    error 80 "Could not find $missing in your ${magenta}PATH${reset}, make sure they are available."
fi

if ! root=$(git rev-parse --show-toplevel 2>/dev/null); then
    error 81 'Not a git repository, make-runner can only be installed in an' \
        'existing git project, run git init if you want a new one and' \
        'execute the installer again.'
fi

cd "$root"

tarball_url=$(curl -fqsSL https://api.github.com/repos/Fleshgrinder/make-runner/releases/latest | jq -r '.tarball_url')

tmpdir=$(mktemp --directory)
trap 'rm -fr $tmpdir' EXIT

(
    cd "$tmpdir"
    curl -fqsSL "$tarball_url" | tar -xzf --strip=1 --wildcards '*/bin/bootstrap-*' '*/resources/make/*'
)

mkdir -p resources/make/
mv "$tmpdir"/resources/make/ resources/make/

include='include resources/make/runner/bootstrap.mk'

if [[ -f Makefile ]]; then
    echo "$include

$(cat Makefile)" >Makefile
else
    echo "$include" >Makefile
fi

exec make help
